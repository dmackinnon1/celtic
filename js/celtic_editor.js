"use strict";
/*
* Classes and functions in this script file are to provide an editible
* representation of the knot. Depends on celtic_base.js, celtic_display.js, bldrs.js
* and evnts.js.
*
* There are three parts to the knot editor
* - a specialized KnotDisplay class
* - some helper functions that interact with the SVG generated by the class
* - a variable "interactive" which holds data used by the live editor.
*
* See the html file index.html file on how to initialize the variables 
* in the 'interactive' object.
*/

class EditDisplay extends KnotDisplay {
	
	constructor(g, scale,foreground = "white", background = "black"){
		super(g, scale, foreground, background);
		this.source = null;
	}
	
	primaryGrid(){
		for (let p in this.g.points){
			let point = this.g.points[p];
			if (point.isOnSecondary()) {
				continue;
			}
			let dot = new Bldr("circle").att("cx",point.x*this.scale).att("cy", point.y*this.scale);
			dot.att("onclick", "primaryClick(event)");
			dot.att("onmouseover","primaryMouseOver(event)");
      		dot.att("onmouseout","primaryMouseOut(event)");
      		dot.att("data_x",point.x);
      		dot.att("data_y", point.y);			
			dot.att("r",this.scale/8).att("stroke-width",0).att("fill","grey");
			this.svgBldr.elem(dot);
		}
		return this; 
	}

	secondaryGrid(){
		for (let p in this.g.nodes){
			let point = this.g.nodes[p];
			let dot = new Bldr("circle").att("cx",point.x*this.scale).att("cy", point.y*this.scale);
			dot.att("r",this.scale/4).att("stroke-width",this.scale/8).att("fill",this.backgroundColor);
			dot.att("onclick", "secondaryClick(event)");
			dot.att("onmouseover","secondaryMouseOver(event)");
      		dot.att("onmouseout","secondaryMouseOut(event)");
      		dot.att("data_x",point.x);
      		dot.att("data_y", point.y);
			this.svgBldr.elem(dot);
		}
		return this; 
	}

	removeJunctionAt(i,j){
		this.g.removeJunctionAt(i,j);
		refreshInteractive();
	}

	setSourceOrTarget(i,j){
		let other = this.g.nodeAt(i,j);
		if (this.source == null){
			this.source = other;
		} else {
			let j = null;
			if (this.source.isWestNeighbor(other) && other.east().junctions.length == 0){
				j = new Junction(this.source, other.east(), other, "EW");
			} else if (this.source.isEastNeighbor(other) && other.west().junctions.length == 0){
				j = new Junction(this.source, other.west(), other, "EW");
			} else if (this.source.isNorthNeighbor(other) && other.south().junctions.length == 0){
				j = new Junction(this.source, other.south(), other, "NS");
			} else if(this.source.isSouthNeighbor(other)&& other.north().junctions.length == 0){
				j = new Junction(this.source, other.north(), other, "NS");
			} else{
				//this.source = other;
				this.g.boxFrame(this.source, other);
				this.source = null;
				refreshInteractive();
			}
			if (j != null){
				this.source = null;
				this.g.junctions.push(j);
				refreshInteractive();
			}
		}
	}

}

//functions and singleton to accompany EditableKnotSVG
let interactive = {};
interactive.knot = null; // knot graph object
interactive.mode = 'show'; // edit or show
interactive.format = 'negative'; // positive | negative
interactive.displayObject = null; //live display object that provids svg
interactive.displayDiv = null; // div in html that will hold the display
interactive.refresh = "refresh"; //event name used in evnt framework

/*
* Functions used with EditDisply
*/
function secondaryClick(event){
	let dot = event.srcElement;
	interactive.displayObject.setSourceOrTarget(
		dot.getAttribute("data_x"),
		dot.getAttribute("data_y"));
};

function primaryClick(event){
	let dot = event.srcElement;
	interactive.displayObject.removeJunctionAt(
		dot.getAttribute("data_x"),
		dot.getAttribute("data_y"));
};

function secondaryMouseOver(event){
	event.srcElement.setAttribute('opacity', '0.5');
};

function secondaryMouseOut(event){
	event.srcElement.setAttribute('opacity', '1');
};

function primaryMouseOver(event){
	event.srcElement.setAttribute('opacity', '0.5');
};

function primaryMouseOut(event){
	event.srcElement.setAttribute('opacity', '1');
};

function refreshInteractive(){
	refreshInteractiveDisplayObject();
	interactive.displayDiv.innerHTML = interactive.displayObject.init().build();
	evnts.fireEvent(interactive.refresh);
};

function refreshInteractiveDisplayObject(){
	if (interactive.mode == 'edit'){		
		interactive.displayObject = new EditDisplay(interactive.knot, interactive.scale);
	} else {
		if (interactive.format == 'positive'){
			interactive.displayObject = 
				new PositiveKnotDisplay(interactive.knot, interactive.scale, 
					interactive.foreground, interactive.background);
		} else {
			interactive.displayObject = new BeveledKnotDisplay(interactive.knot, interactive.scale,
				interactive.foreground, interactive.background);		
		}
	}
};
